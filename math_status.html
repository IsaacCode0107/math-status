<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸èª²ç¨‹é€²åº¦è¿½è¹¤Excelè¡¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Removed SQL.js dependency - using backend SQLite API instead -->
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.success {
            background: #27ae60;
        }
        .btn.success:hover {
            background: #219a52;
        }
        .btn.warning {
            background: #f39c12;
        }
        .btn.warning:hover {
            background: #d68910;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .stats-panel.hidden {
            display: none;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-card h3 {
            margin: 0 0 4px 0;
            font-size: 0.75em;
            font-weight: 500;
            opacity: 0.9;
        }
        .stat-number {
            font-size: 1.3em;
            font-weight: bold;
            margin: 2px 0;
            line-height: 1;
        }
        .stat-unit {
            font-size: 0.65em;
            opacity: 0.8;
            margin: 0;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            font-size: 13px;
        }
        .excel-table th,
        .excel-table td {
            border: 1px solid #d4d4d4;
            padding: 6px 8px;
            text-align: left;
            vertical-align: middle;
        }
        .excel-table th {
            background-color: #217346;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        .excel-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .excel-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .chapter-row {
            background-color: #4472c4 !important;
            color: white;
            font-weight: bold;
        }
        .chapter-summary-row {
            background-color: #b4c7e7 !important;
            font-weight: bold;
            color: #1f4e79;
        }
        
        .status-select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            font-size: 12px;
        }
        .status-completed {
            background-color: #d5e8d4;
            color: #2d6a2d;
        }
        .status-pending {
            background-color: #fff2cc;
            color: #b8860b;
        }
        .status-not-started {
            background-color: #f8cecc;
            color: #8b0000;
        }
        
        .progress-cell {
            text-align: center;
            font-weight: bold;
        }
        .time-cell {
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        .file-input {
            display: none;
        }
        
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #notification.show {
            opacity: 1;
        }
        
        .formula-info {
            background: #e8f4f8;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 11px;
            color: #2c3e50;
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ•¸å­¸èª²ç¨‹é€²åº¦è¿½è¹¤Excelè¡¨ (ç¬¬ä¸‰å†Š + ç¬¬å››å†Š + é¸ä¿®æ•¸ç”²)</h1>
        
        <div class="controls">
            <button class="btn success" onclick="generateExcel()">ğŸ“¥ Excel</button>
            <button class="btn" onclick="importExcel()">ğŸ“‚ åŒ¯å…¥Excel</button>
            <button class="btn warning" onclick="exportData()">ğŸ’¾ åŒ¯å‡º</button>
            <button class="btn" onclick="importData()">ğŸ“„ åŒ¯å…¥</button>
            <button class="btn danger" onclick="resetAllProgress()">ğŸ”„ é‡è¨­</button>
            <button class="btn" onclick="toggleStats()" id="statsToggle" title="åˆ‡æ›çµ±è¨ˆé¡¯ç¤º">ğŸ“Š çµ±è¨ˆ</button>
            <button class="btn" onclick="manualSave()" title="æ‰‹å‹•ä¿å­˜">ğŸ’¾</button>
            <button class="btn" onclick="manualLoad()" title="æ‰‹å‹•è¼‰å…¥">ğŸ“‚</button>
            <button class="btn" onclick="reloadTable()" title="é‡æ–°è¼‰å…¥è¡¨æ ¼">ğŸ”„ é‡è¼‰</button>
            <button class="btn" onclick="exportServerData()" title="åŒ¯å‡ºä¼ºæœå™¨è³‡æ–™">ğŸ“¦ åŒ¯å‡º</button>
            <button class="btn" onclick="showServerStats()" title="æª¢è¦–ä¼ºæœå™¨çµ±è¨ˆ">ğŸ“Š ä¼ºæœå™¨</button>
        </div>
        
        <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
        <input type="file" id="dataFile" class="file-input" accept=".json" onchange="handleDataImport(event)">
        
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stat-card">
                <h3>ç¸½èª²ç¨‹æ•¸</h3>
                <div class="stat-number" id="totalCourses">45</div>
                <div class="stat-unit">å ‚èª²</div>
            </div>
            <div class="stat-card">
                <h3>å·²å®Œæˆ</h3>
                <div class="stat-number" id="completedCourses">5</div>
                <div class="stat-unit">å ‚èª²</div>
            </div>
            <div class="stat-card">
                <h3>å®Œæˆç‡</h3>
                <div class="stat-number" id="completionRate">11.1%</div>
                <div class="stat-unit">é€²åº¦</div>
            </div>
            <div class="stat-card">
                <h3>é ä¼°å‰©é¤˜æ™‚é–“</h3>
                <div class="stat-number" id="remainingTime">17.1</div>
                <div class="stat-unit">å°æ™‚</div>
            </div>
        </div>
        
        <div class="formula-info" style="display: none;">
            ğŸ’¡ <strong>ExcelåŠŸèƒ½ï¼š</strong> 
            ç‹€æ…‹æ¬„ä½ä½¿ç”¨ä¸‹æ‹‰é¸å–®ï¼Œçµ±è¨ˆè‡ªå‹•è¨ˆç®—ã€‚Excelå…¬å¼ï¼šå®Œæˆç‡=COUNTIF(ç‹€æ…‹æ¬„,"å·²å®Œæˆ")/ç¸½æ•¸*100
        </div>
        
        <table class="excel-table" id="courseTable">
            <thead>
                <tr>
                    <th style="width: 120px;">èª²ç¨‹ç·¨è™Ÿ</th>
                    <th style="width: 250px;">èª²ç¨‹åç¨±</th>
                    <th style="width: 80px;">æ™‚é•·</th>
                    <th style="width: 100px;">ç‹€æ…‹</th>
                    <th style="width: 150px;">å‚™è¨»</th>
                    <th style="width: 100px;">å®Œæˆæ—¥æœŸ</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
            </tbody>
        </table>
        
        <div id="notification">æ“ä½œå®Œæˆï¼</div>

        <!-- Add input and button for saving data -->
        <div>
          <input type="text" id="dataInput" placeholder="Enter data to save">
          <button class="btn" onclick="saveData()">Save Data</button>
        </div>

        <!-- Add a section to display fetched data -->
        <div>
          <h3>Saved Data:</h3>
          <ul id="dataList"></ul>
        </div>
    </div>

    <script>
        // èª²ç¨‹è³‡æ–™çµæ§‹ - åŒ…å«ç¬¬ä¸‰å†Šå’Œç¬¬å››å†Š
        const courseData = {
            "ç¬¬ä¸‰å†Š ç¬¬ä¸€ç«  ä¸‰è§’å‡½æ•¸": [
                { code: "1-1_ä¸»é¡Œ1", name: "å¼§åº¦é‡(A+Bç‰ˆ)", time: "40:39", status: "å·²å®Œæˆ", note: "åŸºç¤æ¦‚å¿µ" },
                { code: "1-1_ä¸»é¡Œ2", name: "æ‰‡å½¢å¼§é•·èˆ‡é¢ç©(A+Bç‰ˆ)", time: "15:20", status: "å·²å®Œæˆ", note: "æ‡‰ç”¨è¨ˆç®—" },
                { code: "1-1_ä¸»é¡Œ3", name: "ä¸‰è§’å‡½æ•¸çš„åœ–å½¢(A+Bç‰ˆ)", time: "01:12:32", status: "å·²å®Œæˆ", note: "åœ–å½¢åˆ†æ" },
                { code: "1-1_ä¸»é¡Œ4", name: "ä¸‰è§’æ–¹ç¨‹å¼(A+Bç‰ˆ)", time: "23:55", status: "é€²è¡Œä¸­", note: "æ–¹ç¨‹æ±‚è§£" },
                { code: "1-1_ä¸»é¡Œ5", name: "ä¸‰è§’ä¸ç­‰å¼(A+Bç‰ˆ)", time: "14:26", status: "æœªé–‹å§‹", note: "ä¸ç­‰å¼è§£æ³•" },
                { code: "1-1_ä¸»é¡Œ6", name: "ä¸‰è§’å‡½æ•¸çš„æ¥µå€¼(A+Bç‰ˆ)", time: "03:37", status: "æœªé–‹å§‹", note: "æ¥µå€¼å•é¡Œ" },
                { code: "1-1_ä¸»é¡Œ7", name: "ä¸‰è§’å‡½æ•¸çš„æ‡‰ç”¨(A+Bç‰ˆ)", time: "13:39", status: "æœªé–‹å§‹", note: "å¯¦éš›æ‡‰ç”¨" },
                { code: "1-2_ä¸»é¡Œ1", name: "å’Œå·®è§’å…¬å¼(Aç‰ˆ)", time: "01:19:38", status: "æœªé–‹å§‹", note: "å…¬å¼æ¨å°" },
                { code: "1-2_ä¸»é¡Œ2", name: "å¹³æ–¹å·®(èª²å¤–è£œå……)(Aç‰ˆ)", time: "06:08", status: "æœªé–‹å§‹", note: "è£œå……å…§å®¹" },
                { code: "1-2_ä¸»é¡Œ3", name: "æ­£åˆ‡çš„å’Œå·®è§’(Aç‰ˆ)", time: "27:06", status: "æœªé–‹å§‹", note: "æ­£åˆ‡å…¬å¼" },
                { code: "1-2_ä¸»é¡Œ4", name: "äºŒå€è§’(Aç‰ˆ)", time: "28:12", status: "æœªé–‹å§‹", note: "å€è§’å…¬å¼" },
                { code: "1-2_ä¸»é¡Œ5", name: "äºŒå€è§’(Aç‰ˆ)", time: "21:51", status: "æœªé–‹å§‹", note: "å»¶çºŒå…§å®¹" },
                { code: "1-2_ä¸»é¡Œ6", name: "åŠè§’å…¬å¼(Aç‰ˆ)", time: "26:03", status: "æœªé–‹å§‹", note: "åŠè§’æ¨å°" },
                { code: "1-3_ä¸»é¡Œ1", name: "æ­£é¤˜å¼¦çš„ç–Šåˆ(Aç‰ˆ)", time: "40:16", status: "æœªé–‹å§‹", note: "å‡½æ•¸ç–Šåˆ" },
                { code: "1-3_ä¸»é¡Œ2", name: "æ­£é¤˜å¼¦ç–Šåˆçš„æ¥µå€¼(Aç‰ˆ)", time: "44:27", status: "æœªé–‹å§‹", note: "æ¥µå€¼è¨ˆç®—" },
                { code: "1-3_ä¸»é¡Œ3", name: "æ­£é¤˜å¼¦ç–Šåˆçš„æ‡‰ç”¨å•é¡Œ(Aç‰ˆ)", time: "28:05", status: "æœªé–‹å§‹", note: "æ‡‰ç”¨é¡Œå‹" }
            ],
            "ç¬¬ä¸‰å†Š ç¬¬äºŒç«  æŒ‡æ•¸èˆ‡å°æ•¸å‡½æ•¸": [
                { code: "2-1_ä¸»é¡Œ1", name: "æŒ‡æ•¸å‡½æ•¸çš„åœ–å½¢(A+Bç‰ˆ)", time: "42:24", status: "æœªé–‹å§‹", note: "åœ–å½¢æ€§è³ª" },
                { code: "2-1_ä¸»é¡Œ2", name: "æŒ‡æ•¸æ¯”å¤§å°(A+Bç‰ˆ)", time: "09:01", status: "æœªé–‹å§‹", note: "å¤§å°æ¯”è¼ƒ" },
                { code: "2-1_ä¸»é¡Œ3", name: "æŒ‡æ•¸æ–¹ç¨‹å¼èˆ‡ä¸ç­‰å¼(A+Bç‰ˆ)", time: "09:01", status: "æœªé–‹å§‹", note: "æ–¹ç¨‹ä¸ç­‰å¼" },
                { code: "2-1_ä¸»é¡Œ4", name: "æŒ‡æ•¸å‡½æ•¸çš„æ¥µå€¼(A+Bç‰ˆ)", time: "11:03", status: "æœªé–‹å§‹", note: "æ¥µå€¼å•é¡Œ" },
                { code: "2-1_ä¸»é¡Œ5", name: "æŒ‡æ•¸å‡½æ•¸çš„æ‡‰ç”¨(A+Bç‰ˆ)", time: "08:15", status: "æœªé–‹å§‹", note: "å¯¦éš›æ‡‰ç”¨" },
                { code: "2-2_ä¸»é¡Œ1", name: "å°æ•¸çš„å®šç¾©(A+Bç‰ˆ)", time: "14:32", status: "æœªé–‹å§‹", note: "åŸºæœ¬å®šç¾©" },
                { code: "2-2_ä¸»é¡Œ2", name: "å°æ•¸å¾‹(A+Bç‰ˆ)", time: "01:04:23", status: "æœªé–‹å§‹", note: "å°æ•¸é‹ç®—å¾‹" },
                { code: "2-2_ä¸»é¡Œ3", name: "å°æ•¸æ–¹ç¨‹(A+Bç‰ˆ)", time: "21:12", status: "æœªé–‹å§‹", note: "æ–¹ç¨‹æ±‚è§£" },
                { code: "2-2_ä¸»é¡Œ4", name: "ç§‘å­¸è¨˜è™Ÿèˆ‡å¸¸ç”¨å°æ•¸(A+Bç‰ˆ)", time: "24:07", status: "æœªé–‹å§‹", note: "ç§‘å­¸æ‡‰ç”¨" },
                { code: "2-3_ä¸»é¡Œ1", name: "å°æ•¸å‡½æ•¸çš„åœ–å½¢(A+Bç‰ˆ)", time: "44:59", status: "æœªé–‹å§‹", note: "åœ–å½¢åˆ†æ" },
                { code: "2-3_ä¸»é¡Œ2", name: "å°æ•¸æ¯”å¤§å°(A+Bç‰ˆ)", time: "12:06", status: "æœªé–‹å§‹", note: "å¤§å°æ¯”è¼ƒ" },
                { code: "2-3_ä¸»é¡Œ3", name: "å°æ•¸ä¸ç­‰å¼(A+Bç‰ˆ)", time: "23:56", status: "æœªé–‹å§‹", note: "ä¸ç­‰å¼è§£æ³•" },
                { code: "2-3_ä¸»é¡Œ4", name: "å°æ•¸æ±‚æ¥µå€¼(A+Bç‰ˆ)", time: "07:08", status: "æœªé–‹å§‹", note: "æ¥µå€¼è¨ˆç®—" },
                { code: "2-3_ä¸»é¡Œ5", name: "å°æ•¸æ‡‰ç”¨å•é¡Œ(A+Bç‰ˆ)", time: "33:57", status: "å·²å®Œæˆ", note: "æ‡‰ç”¨é¡Œå‹" }
            ],
            "ç¬¬ä¸‰å†Š ç¬¬ä¸‰ç«  å¹³é¢å‘é‡": [
                { code: "3-1_ä¸»é¡Œ1", name: "å¹³é¢å‘é‡çš„å¹¾ä½•è¡¨ç¤ºæ³•(A+Bç‰ˆ)", time: "05:53", status: "æœªé–‹å§‹", note: "å¹¾ä½•è¡¨ç¤º" },
                { code: "3-1_ä¸»é¡Œ2", name: "å¹³é¢å‘é‡çš„åº§æ¨™è¡¨ç¤ºæ³•(A+Bç‰ˆ)", time: "14:51", status: "æœªé–‹å§‹", note: "åº§æ¨™è¡¨ç¤º" },
                { code: "3-1_ä¸»é¡Œ3", name: "å‘é‡çš„é‹ç®—(A+Bç‰ˆ)", time: "24:45", status: "å·²å®Œæˆ", note: "åŸºæœ¬é‹ç®—" },
                { code: "3-1_ä¸»é¡Œ4", name: "å‘é‡çš„ç·šæ€§çµ„åˆ(A+Bç‰ˆ)", time: "28:52", status: "æœªé–‹å§‹", note: "ç·šæ€§çµ„åˆ" },
                { code: "3-1_ä¸»é¡Œ5", name: "å…±ç·šç†è«–(A+Bç‰ˆ)", time: "35:00", status: "æœªé–‹å§‹", note: "å…±ç·šæ€§è³ª" },
                { code: "3-1_ä¸»é¡Œ6", name: "é¢ç©æ¯”(A+Bç‰ˆ)", time: "07:25", status: "æœªé–‹å§‹", note: "é¢ç©è¨ˆç®—" },
                { code: "3-1_ä¸»é¡Œ7", name: "æ–œåº§æ¨™(A+Bç‰ˆ)", time: "19:00", status: "æœªé–‹å§‹", note: "åº§æ¨™ç³»çµ±" },
                { code: "3-2_ä¸»é¡Œ1", name: "å…§ç©(A+Bç‰ˆ)", time: "26:00", status: "æœªé–‹å§‹", note: "å…§ç©é‹ç®—" },
                { code: "3-2_ä¸»é¡Œ2", name: "å…§ç©çš„æ€§è³ª(A+Bç‰ˆ)", time: "14:19", status: "æœªé–‹å§‹", note: "æ€§è³ªæ¢è¨" },
                { code: "3-2_ä¸»é¡Œ3", name: "æ­£å°„å½±(A+Bç‰ˆ)", time: "26:11", status: "æœªé–‹å§‹", note: "æŠ•å½±è¨ˆç®—" },
                { code: "3-2_ä¸»é¡Œ4", name: "ç›´ç·šåƒæ•¸å¼(A+Bç‰ˆ)", time: "27:25", status: "æœªé–‹å§‹", note: "åƒæ•¸æ–¹ç¨‹" },
                { code: "3-2_ä¸»é¡Œ5", name: "ç›´ç·šçš„å¤¾è§’(A+Bç‰ˆ)", time: "10:36", status: "æœªé–‹å§‹", note: "è§’åº¦è¨ˆç®—" },
                { code: "3-2_ä¸»é¡Œ6", name: "æŸ¯è¥¿ä¸ç­‰å¼(Aç‰ˆ)", time: "26:59", status: "æœªé–‹å§‹", note: "ä¸ç­‰å¼ç†è«–" },
                { code: "3-3_ä¸»é¡Œ1", name: "å‘é‡çš„é¢ç©å…¬å¼(Aç‰ˆ)", time: "18:09", status: "æœªé–‹å§‹", note: "é¢ç©å…¬å¼" },
                { code: "3-3_ä¸»é¡Œ2", name: "äºŒéšè¡Œåˆ—å¼(Aç‰ˆ)", time: "29:15", status: "æœªé–‹å§‹", note: "è¡Œåˆ—å¼è¨ˆç®—" },
                { code: "3-3_ä¸»é¡Œ3", name: "å…‹æ‹‰ç‘ªå…¬å¼(Aç‰ˆ)", time: "12:17", status: "æœªé–‹å§‹", note: "ç·šæ€§æ–¹ç¨‹çµ„" },
                { code: "3-3_ä¸»é¡Œ4", name: "äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹çµ„çš„å‘é‡è§€é»(Aç‰ˆ)", time: "12:02", status: "æœªé–‹å§‹", note: "å‘é‡è§€é»" }
            ],
            "ç¬¬å››å†Š ç¬¬å››ç«  ç©ºé–“å‘é‡": [
                { code: "1-1_ä¸»é¡Œ1", name: "ç©ºé–“æ¦‚å¿µ(A+Bç‰ˆ)", time: "23:07", status: "æœªé–‹å§‹", note: "åŸºç¤æ¦‚å¿µ" },
                { code: "1-1_ä¸»é¡Œ2", name: "äºŒé¢è§’(A+Bç‰ˆ)", time: "30:00", status: "æœªé–‹å§‹", note: "è§’åº¦è¨ˆç®—" },
                { code: "1-1_ä¸»é¡Œ3", name: "ç«‹é«”åœ–å½¢è¨ˆç®—(A+Bç‰ˆ)", time: "14:50", status: "æœªé–‹å§‹", note: "ç«‹é«”å¹¾ä½•" },
                { code: "1-2_ä¸»é¡Œ1", name: "ç©ºé–“åæ¨™ç³»(A+Bç‰ˆ)", time: "32:39", status: "æœªé–‹å§‹", note: "åæ¨™ç³»çµ±" },
                { code: "1-2_ä¸»é¡Œ2", name: "ç©ºé–“å‘é‡çš„è¡¨ç¤ºæ³•(A+Bç‰ˆ)", time: "25:52", status: "æœªé–‹å§‹", note: "å‘é‡è¡¨ç¤º" },
                { code: "1-2_ä¸»é¡Œ3", name: "ç©ºé–“å‘é‡çš„ç·šæ€§çµ„åˆ(A+Bç‰ˆ)", time: "11:01", status: "æœªé–‹å§‹", note: "ç·šæ€§é‹ç®—" },
                { code: "1-3_ä¸»é¡Œ1", name: "ç©ºé–“å‘é‡çš„å…§ç©(Aç‰ˆ)", time: "21:25", status: "æœªé–‹å§‹", note: "å…§ç©è¨ˆç®—" },
                { code: "1-3_ä¸»é¡Œ2", name: "æŸ¯è¥¿ä¸ç­‰å¼(Aç‰ˆ)", time: "21:58", status: "æœªé–‹å§‹", note: "ä¸ç­‰å¼" },
                { code: "1-4_ä¸»é¡Œ1", name: "å¤–ç©(Aç‰ˆ)", time: "18:27", status: "æœªé–‹å§‹", note: "å¤–ç©é‹ç®—" },
                { code: "è£œå……", name: "å…§ç©èˆ‡å¤–ç©æ¯”è¼ƒ", time: "06:34", status: "æœªé–‹å§‹", note: "æ¦‚å¿µæ¯”è¼ƒ" },
                { code: "1-4_ä¸»é¡Œ2", name: "ç©ºé–“å‘é‡æ±‚é«”ç©(Aç‰ˆ)", time: "04:57", status: "æœªé–‹å§‹", note: "é«”ç©è¨ˆç®—" },
                { code: "1-4_ä¸»é¡Œ3", name: "ä¸‰éšè¡Œåˆ—å¼(Aç‰ˆ)", time: "24:50", status: "æœªé–‹å§‹", note: "è¡Œåˆ—å¼" },
                { code: "1-4_ä¸»é¡Œ4", name: "ä¸‰éšè¡Œåˆ—å¼çš„æ‡‰ç”¨(Aç‰ˆ)", time: "12:44", status: "æœªé–‹å§‹", note: "æ‡‰ç”¨è¨ˆç®—" },
                { code: "æ•¸Bè£œå……", name: "å¦‚ä½•åˆ¤æ–·åœ“éŒæˆªç—•", time: "04:27", status: "æœªé–‹å§‹", note: "å¹¾ä½•åˆ¤æ–·" },
                { code: "æ•¸Bè£œå……", name: "çƒé¢èˆ‡ç¶“ç·¯åº¦", time: "20:27", status: "æœªé–‹å§‹", note: "çƒé¢å¹¾ä½•" }
            ],
            "ç¬¬å››å†Šç¬¬äº”ç«  ç©ºé–“çš„å¹³é¢èˆ‡ç›´ç·š(Aç‰ˆ)": [
                { code: "2-1_ä¸»é¡Œ1", name: "å¹³é¢æ–¹ç¨‹å¼", time: "24:59", status: "æœªé–‹å§‹", note: "æ–¹ç¨‹å»ºç«‹" },
                { code: "2-1_ä¸»é¡Œ2", name: "å¹³é¢çš„æˆªè·å¼", time: "18:42", status: "æœªé–‹å§‹", note: "æˆªè·è¡¨ç¤º" },
                { code: "2-1_ä¸»é¡Œ3", name: "å¹³é¢çš„å¤¾è§’", time: "09:30", status: "æœªé–‹å§‹", note: "è§’åº¦è¨ˆç®—" },
                { code: "2-1_ä¸»é¡Œ4", name: "é»åˆ°å¹³é¢çš„è·é›¢", time: "24:21", status: "æœªé–‹å§‹", note: "è·é›¢å…¬å¼" },
                { code: "2-2_ä¸»é¡Œ1", name: "ç›´ç·šæ–¹ç¨‹å¼", time: "37:02", status: "æœªé–‹å§‹", note: "æ–¹ç¨‹å»ºç«‹" },
                { code: "2-2_ä¸»é¡Œ2", name: "ç›´ç·šèˆ‡å¹³é¢", time: "29:32", status: "æœªé–‹å§‹", note: "é—œä¿‚åˆ†æ" },
                { code: "2-2_ä¸»é¡Œ3", name: "é»èˆ‡ç›´ç·š", time: "06:50", status: "æœªé–‹å§‹", note: "ä½ç½®é—œä¿‚" },
                { code: "2-2_ä¸»é¡Œ4", name: "ç›´ç·šèˆ‡ç›´ç·š", time: "39:55", status: "æœªé–‹å§‹", note: "ç·šç·šé—œä¿‚" }
            ],
            "ç¬¬å››å†Š ç¬¬å…­ç«  æ¢ä»¶æ©Ÿç‡(A+Bç‰ˆ)": [
                { code: "3-1~3-2_ä¸»é¡Œ1", name: "æ¢ä»¶æ©Ÿç‡", time: "23:37", status: "æœªé–‹å§‹", note: "æ©Ÿç‡è¨ˆç®—" },
                { code: "3-2_ä¸»é¡Œ2", name: "ç¨ç«‹äº‹ä»¶", time: "30:05", status: "æœªé–‹å§‹", note: "äº‹ä»¶ç¨ç«‹æ€§" },
                { code: "3-3_ä¸»é¡Œ1", name: "è²æ°å®šç†", time: "27:36", status: "æœªé–‹å§‹", note: "å®šç†æ‡‰ç”¨" }
            ],
            "ç¬¬å››å†Š ç¬¬ä¸ƒç«  çŸ©é™£": [
                { code: "4-1_ä¸»é¡Œ1", name: "é«˜æ–¯æ¶ˆå»æ³•(Aç‰ˆ)", time: "37:19", status: "æœªé–‹å§‹", note: "è§£æ–¹ç¨‹çµ„" },
                { code: "4-2_ä¸»é¡Œ1", name: "çŸ©é™£çš„åŠ æ¸›æ³•(A+Bç‰ˆ)", time: "11:50", status: "æœªé–‹å§‹", note: "åŸºæœ¬é‹ç®—" },
                { code: "4-2_ä¸»é¡Œ2", name: "çŸ©é™£çš„ä¹˜æ³•(A+Bç‰ˆ)", time: "21:19", status: "æœªé–‹å§‹", note: "ä¹˜æ³•é‹ç®—" },
                { code: "4-2_ä¸»é¡Œ3", name: "çŸ©é™£çš„é«˜æ¬¡æ–¹(A+Bç‰ˆ)", time: "24:19", status: "æœªé–‹å§‹", note: "å†ªæ¬¡è¨ˆç®—" },
                { code: "4-2_ä¸»é¡Œ4", name: "åæ–¹é™£(A+Bç‰ˆ)", time: "46:26", status: "æœªé–‹å§‹", note: "é€†çŸ©é™£" },
                { code: "4-3_ä¸»é¡Œ1", name: "è½‰ç§»çŸ©é™£(Aç‰ˆ)", time: "38:11", status: "æœªé–‹å§‹", note: "ç‹€æ…‹è½‰ç§»" },
                { code: "4-3_ä¸»é¡Œ2~3", name: "å¹³é¢ç·šæ€§è®Šæ›(Aç‰ˆ)", time: "10:19", status: "æœªé–‹å§‹", note: "å¹¾ä½•è®Šæ›" },
                { code: "4-3_ä¸»é¡Œ4~5", name: "ä¼¸ç¸®èˆ‡æ¨ç§»çŸ©é™£(Aç‰ˆ)", time: "13:58", status: "æœªé–‹å§‹", note: "è®Šæ›çŸ©é™£" },
                { code: "4-3_ä¸»é¡Œ6", name: "é¡å°„çŸ©é™£(Aç‰ˆ)", time: "12:17", status: "æœªé–‹å§‹", note: "å°ç¨±è®Šæ›" },
                { code: "4-3_ä¸»é¡Œ7", name: "æ—‹è½‰çŸ©é™£(Aç‰ˆ)", time: "24:45", status: "æœªé–‹å§‹", note: "æ—‹è½‰è®Šæ›" }
            ]
        };

        // åˆå§‹åŒ–è¡¨æ ¼
        function initializeTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            let globalChapterIndex = 1;
            
            Object.keys(courseData).forEach(chapterName => {
                // ç« ç¯€æ¨™é¡Œè¡Œ - ç›´æ¥ä½¿ç”¨å®Œæ•´çš„ç« ç¯€åç¨±
                const chapterRow = document.createElement('tr');
                chapterRow.className = 'chapter-row';
                
                chapterRow.innerHTML = `
                    <td colspan="6" style="text-align: center; font-size: 14px;">
                        ğŸ”¸ ${chapterName}
                    </td>
                `;
                tbody.appendChild(chapterRow);
                
                // ç« ç¯€çµ±è¨ˆè¡Œ
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'chapter-summary-row';
                summaryRow.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 8px;">
                        <span id="ch${globalChapterIndex}_summary">è¼‰å…¥ä¸­...</span>
                    </td>
                `;
                tbody.appendChild(summaryRow);
                
                // èª²ç¨‹è¡Œ
                courseData[chapterName].forEach(course => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${course.code}</td>
                        <td>${course.name}</td>
                        <td class="time-cell">${course.time}</td>
                        <td>
                            <select class="status-select" onchange="updateStatus(this)" data-chapter="${globalChapterIndex}">
                                <option value="æœªé–‹å§‹" ${course.status === 'æœªé–‹å§‹' ? 'selected' : ''}>æœªé–‹å§‹</option>
                                <option value="é€²è¡Œä¸­" ${course.status === 'é€²è¡Œä¸­' ? 'selected' : ''}>é€²è¡Œä¸­</option>
                                <option value="å·²å®Œæˆ" ${course.status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="note-input" value="${course.note}" onchange="updateNote(this)" 
                                   style="width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 3px;">
                        </td>
                        <td>
                            <input type="date" class="date-input" value="" 
                                   onchange="updateDate(this)" 
                                   style="width: 100%; border: 1px solid #ddd; padding: 4px; border-radius: 3px;">
                        </td>
                    `;
                    
                    // è¨­ç½®ç‹€æ…‹é¡è‰²
                    const select = row.querySelector('.status-select');
                    updateSelectColor(select);
                    
                    tbody.appendChild(row);
                });
                
                globalChapterIndex++;
            });
            
            updateAllStatistics();
        }

        // æ›´æ–°å‚™è¨»
        function updateNote(input) {
            saveProgressToServer(); // è‡ªå‹•ä¿å­˜é€²åº¦åˆ°ä¼ºæœå™¨
            showNotification('å‚™è¨»å·²æ›´æ–°ï¼');
        }

        // æ›´æ–°å®Œæˆæ—¥æœŸ
        function updateDate(input) {
            saveProgressToServer(); // è‡ªå‹•ä¿å­˜é€²åº¦åˆ°ä¼ºæœå™¨
            showNotification('æ—¥æœŸå·²æ›´æ–°ï¼');
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚ºè¼¸å…¥æ¬„ä½ä½¿ç”¨çš„æ ¼å¼ (YYYY-MM-DD)
        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            try {
                // å¦‚æœæ˜¯ YYYY/MM/DD æ ¼å¼ï¼Œè½‰æ›ç‚º YYYY-MM-DD
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    }
                }
                return dateStr;
            } catch (e) {
                return '';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚ºé¡¯ç¤ºæ ¼å¼ (YYYY/MM/DD)
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            try {
                // å¦‚æœæ˜¯ YYYY-MM-DD æ ¼å¼ï¼Œè½‰æ›ç‚º YYYY/MM/DD
                if (dateStr.includes('-')) {
                    return dateStr.replace(/-/g, '/');
                }
                return dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        // æ›´æ–°ç‹€æ…‹
        function updateStatus(select) {
            updateSelectColor(select);

            const row = select.closest('tr');
            const dateInput = row.querySelector('.date-input');
            if (select.value === 'å·²å®Œæˆ' && !dateInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            } else if (select.value !== 'å·²å®Œæˆ') {
                dateInput.value = '';
            }

            updateAllStatistics();
            saveProgressToServer(); // è‡ªå‹•ä¿å­˜é€²åº¦åˆ°ä¼ºæœå™¨
            showNotification('ç‹€æ…‹å·²æ›´æ–°ï¼');
        }

        // æ›´æ–°ä¸‹æ‹‰é¸å–®é¡è‰²
        function updateSelectColor(select) {
            select.className = 'status-select';
            if (select.value === 'å·²å®Œæˆ') {
                select.classList.add('status-completed');
            } else if (select.value === 'é€²è¡Œä¸­') {
                select.classList.add('status-pending');
            } else {
                select.classList.add('status-not-started');
            }
        }

        // ç²å–ç•¶å‰æ—¥æœŸ
        function getCurrentDate() {
            return new Date().toLocaleDateString('zh-TW');
        }

        // æ›´æ–°æ‰€æœ‰çµ±è¨ˆ
        function updateAllStatistics() {
            const selects = document.querySelectorAll('.status-select');
            let totalCourses = selects.length;
            let completedCount = 0;
            let inProgressCount = 0;
            let totalMinutes = 0;
            let completedMinutes = 0;
            
            // è¨ˆç®—ç« ç¯€çµ±è¨ˆ
            const chapterStats = {};
            
            selects.forEach(select => {
                const chapter = select.dataset.chapter;
                if (!chapterStats[chapter]) {
                    chapterStats[chapter] = { total: 0, completed: 0, inProgress: 0, totalTime: 0 };
                }
                
                chapterStats[chapter].total++;
                
                // è¨ˆç®—æ™‚é–“
                const row = select.closest('tr');
                const timeCell = row.querySelector('.time-cell');
                const minutes = parseTimeToMinutes(timeCell.textContent);
                totalMinutes += minutes;
                chapterStats[chapter].totalTime += minutes;
                
                if (select.value === 'å·²å®Œæˆ') {
                    completedCount++;
                    chapterStats[chapter].completed++;
                    completedMinutes += minutes;
                } else if (select.value === 'é€²è¡Œä¸­') {
                    inProgressCount++;
                    chapterStats[chapter].inProgress++;
                }
            });
            
            // æ›´æ–°ç¸½é«”çµ±è¨ˆ
            const completionRate = totalCourses > 0 ? ((completedCount / totalCourses) * 100).toFixed(1) : 0;
            const remainingTime = ((totalMinutes - completedMinutes) / 60).toFixed(1);
            
            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('completedCourses').textContent = completedCount;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('remainingTime').textContent = remainingTime;
            
            // æ›´æ–°ç« ç¯€çµ±è¨ˆ
            Object.keys(chapterStats).forEach(chapter => {
                const stats = chapterStats[chapter];
                const hours = Math.floor(stats.totalTime / 60);
                const mins = Math.round(stats.totalTime % 60);
                const progress = ((stats.completed / stats.total) * 100).toFixed(1);
                
                const summaryElement = document.getElementById(`ch${chapter}_summary`);
                if (summaryElement) {
                    summaryElement.innerHTML = `
                        ğŸ“š ${stats.total}å ‚ | â±ï¸ ${hours}h${mins}m | 
                        âœ… ${stats.completed}å®Œæˆ | ğŸ”„ ${stats.inProgress}é€²è¡Œä¸­ | 
                        ğŸ“ˆ ${progress}%
                    `;
                }
            });
        }

        // è§£ææ™‚é–“ç‚ºåˆ†é˜
        function parseTimeToMinutes(timeStr) {
            const parts = timeStr.split(':');
            if (parts.length === 3) {
                return parseInt(parts[0]) * 60 + parseInt(parts[1]) + parseInt(parts[2]) / 60;
            } else if (parts.length === 2) {
                return parseInt(parts[0]) + parseInt(parts[1]) / 60;
            }
            return 0;
        }

        // ç”¢ç”ŸExcelæª”æ¡ˆ
        function generateExcel() {
            const wb = XLSX.utils.book_new();
            
            // æº–å‚™è³‡æ–™
            const data = [];
            
            // æ¨™é¡Œè¡Œ
            data.push(['ç« ç¯€', 'èª²ç¨‹ç·¨è™Ÿ', 'èª²ç¨‹åç¨±', 'æ™‚é•·', 'ç‹€æ…‹', 'å‚™è¨»', 'å®Œæˆæ—¥æœŸ']);
            
            // èª²ç¨‹è³‡æ–™
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                if (!row.classList.contains('chapter-row') && !row.classList.contains('chapter-summary-row')) {
                    const cells = row.querySelectorAll('td, select');
                    const statusSelect = row.querySelector('.status-select');
                    const rowData = [
                        cells[0].textContent.trim(),
                        cells[1].textContent.trim(),
                        cells[2].textContent.trim(),
                        cells[3].textContent.trim(),
                        statusSelect.value,
                        cells[5].textContent.trim(),
                        cells[6].textContent.trim()
                    ];
                    data.push(rowData);
                }
            });
            
            // å»ºç«‹å·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // è¨­ç½®æ¬„å¯¬
            ws['!cols'] = [
                { wch: 6 },   // ç« ç¯€
                { wch: 15 },  // èª²ç¨‹ç·¨è™Ÿ
                { wch: 35 },  // èª²ç¨‹åç¨±
                { wch: 10 },  // æ™‚é•·
                { wch: 12 },  // ç‹€æ…‹
                { wch: 15 },  // å‚™è¨»
                { wch: 12 }   // å®Œæˆæ—¥æœŸ
            ];
            
            // æ–°å¢çµ±è¨ˆå·¥ä½œè¡¨
            const statsData = [
                ['çµ±è¨ˆé …ç›®', 'æ•¸å€¼'],
                ['ç¸½èª²ç¨‹æ•¸', document.getElementById('totalCourses').textContent],
                ['å·²å®Œæˆèª²ç¨‹', document.getElementById('completedCourses').textContent],
                ['å®Œæˆç‡', document.getElementById('completionRate').textContent],
                ['é ä¼°å‰©é¤˜æ™‚é–“(å°æ™‚)', document.getElementById('remainingTime').textContent],
                [],
                ['ç‹€æ…‹', 'èªªæ˜'],
                ['å·²å®Œæˆ', 'èª²ç¨‹å·²å­¸ç¿’å®Œç•¢'],
                ['é€²è¡Œä¸­', 'èª²ç¨‹æ­£åœ¨å­¸ç¿’ä¸­'],
                ['æœªé–‹å§‹', 'èª²ç¨‹å°šæœªé–‹å§‹å­¸ç¿’']
            ];
            
            const statsWs = XLSX.utils.aoa_to_sheet(statsData);
            statsWs['!cols'] = [{ wch: 15 }, { wch: 20 }];
            
            // åŠ å…¥å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'èª²ç¨‹é€²åº¦');
            XLSX.utils.book_append_sheet(wb, statsWs, 'çµ±è¨ˆè³‡æ–™');
            
            // ä¸‹è¼‰Excelæª”æ¡ˆ
            const fileName = `æ•¸å­¸èª²ç¨‹é€²åº¦_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Excelæª”æ¡ˆå·²ç”¢ç”Ÿä¸¦ä¸‹è¼‰ï¼');
        }

        // åŒ¯å…¥Excel
        function importExcel() {
            document.getElementById('excelFile').click();
        }

        // è™•ç†ExcelåŒ¯å…¥
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // è·³éæ¨™é¡Œè¡Œï¼Œæ›´æ–°ç‹€æ…‹
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length >= 5) {
                            const courseCode = row[1];
                            const status = row[4];
                            const completedDate = row[6] || '';
                            
                            // æ‰¾åˆ°å°æ‡‰çš„è¡Œä¸¦æ›´æ–°
                            const selects = document.querySelectorAll('.status-select');
                            selects.forEach(select => {
                                const tableRow = select.closest('tr');
                                const codeCell = tableRow.querySelector('td:nth-child(2)');
                                if (codeCell && codeCell.textContent.trim() === courseCode) {
                                    select.value = status;
                                    updateSelectColor(select);
                                    
                                    const dateCell = tableRow.querySelector('.completed-date');
                                    if (dateCell) {
                                        dateCell.textContent = completedDate;
                                    }
                                }
                            });
                        }
                    }
                    
                    updateAllStatistics();
                    saveProgressToServer();
                    showNotification('Excelè³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('Excelæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆå…§å®¹æ­£ç¢ºï¼');
                    console.error('ExcelåŒ¯å…¥éŒ¯èª¤:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // åŒ¯å‡ºè³‡æ–™åˆ° localStorage
        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                courses: []
            };
            
            const selects = document.querySelectorAll('.status-select');
            selects.forEach(select => {
                const row = select.closest('tr');
                if (!row.classList.contains('chapter-row') && !row.classList.contains('chapter-summary-row')) {
                    const cells = row.querySelectorAll('td');
                    const courseData = {
                        chapter: cells[0].textContent.trim(),
                        code: cells[1].textContent.trim(),
                        name: cells[2].textContent.trim(),
                        time: cells[3].textContent.trim(),
                        status: select.value,
                        note: row.querySelector('.note-input').value.trim(),
                        completedDate: row.querySelector('.date-input').value.trim()
                    };
                    data.courses.push(courseData);
                }
            });

            localStorage.setItem('mathProgressData', JSON.stringify(data));
            showNotification('é€²åº¦å·²ä¿å­˜åˆ°ç€è¦½å™¨ï¼');
        }

        // è¼‰å…¥è³‡æ–™å¾ localStorage
        function loadJsonData() {
            const data = localStorage.getItem('mathProgressData');
            if (data) {
                try {
                    const parsedData = JSON.parse(data);
                    if (parsedData.courses) {
                        // æ¸…ç©ºè¡¨æ ¼ä¸¦é‡æ–°åˆå§‹åŒ–
                        const tbody = document.getElementById('tableBody');
                        tbody.innerHTML = '';
                        initializeTable();

                        // æ›´æ–°è¡¨æ ¼ä¸­çš„æ¯ä¸€è¡Œ
                        parsedData.courses.forEach(course => {
                            const selects = document.querySelectorAll('.status-select');
                            selects.forEach(select => {
                                const row = select.closest('tr');
                                const codeCell = row.querySelector('td:nth-child(1)');
                                if (codeCell && codeCell.textContent.trim() === course.code) {
                                    select.value = course.status || 'æœªé–‹å§‹';
                                    updateSelectColor(select);

                                    const noteInput = row.querySelector('.note-input');
                                    if (noteInput && course.note) {
                                        noteInput.value = course.note;
                                    }

                                    const dateInput = row.querySelector('.date-input');
                                    if (dateInput && course.completedDate) {
                                        dateInput.value = course.completedDate;
                                    }
                                }
                            });
                        });

                        updateAllStatistics();
                        showNotification('é€²åº¦å·²è¼‰å…¥ï¼');
                    }
                } catch (error) {
                    console.error('è¼‰å…¥é€²åº¦å¤±æ•—:', error);
                }
            }
        }

        // ä¼ºæœå™¨ API é…ç½®
        const API_BASE_URL = 'http://localhost:3000';
        
        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        async function initApp() {
            try {
                console.log('æ­£åœ¨åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
                await loadProgressFromServer();
                console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
                // å¦‚æœä¼ºæœå™¨ç„¡æ³•é€£æ¥ï¼Œè¼‰å…¥æœ¬åœ°å„²å­˜çš„è³‡æ–™
                loadProgress();
            }
        }

        // ä¿å­˜é€²åº¦åˆ°ä¼ºæœå™¨
        async function saveProgressToServer() {
            try {
                const courses = [];
                const selects = document.querySelectorAll('.status-select');
                
                selects.forEach(select => {
                    const row = select.closest('tr');
                    if (!row.classList.contains('chapter-row') && !row.classList.contains('chapter-summary-row')) {
                        const cells = row.querySelectorAll('td');
                        const noteInput = row.querySelector('.note-input');
                        const dateInput = row.querySelector('.date-input');

                        const courseData = {
                            code: cells[0].textContent.trim(),
                            name: cells[1].textContent.trim(),
                            time: cells[2].textContent.trim(),
                            status: select.value,
                            note: noteInput ? noteInput.value.trim() : '',
                            completedDate: dateInput ? dateInput.value.trim() : ''
                        };
                        courses.push(courseData);
                    }
                });

                console.log('æ­£åœ¨ä¿å­˜é€²åº¦åˆ°ä¼ºæœå™¨...', courses.length, 'ç­†è³‡æ–™');
                
                const response = await fetch(`${API_BASE_URL}/save-progress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ courses })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('é€²åº¦å·²æˆåŠŸä¿å­˜åˆ°ä¼ºæœå™¨:', result);
                    // åŒæ™‚ä¿å­˜åˆ° localStorage ä½œç‚ºå‚™ä»½
                    saveProgress();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('ä¿å­˜é€²åº¦åˆ°ä¼ºæœå™¨å¤±æ•—:', error);
                // å¦‚æœä¼ºæœå™¨ä¿å­˜å¤±æ•—ï¼Œè‡³å°‘ä¿å­˜åˆ°æœ¬åœ°
                saveProgress();
                showNotification('ä¼ºæœå™¨ä¿å­˜å¤±æ•—ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°å„²å­˜');
            }
        }

        // å¾ä¼ºæœå™¨è¼‰å…¥é€²åº¦
        async function loadProgressFromServer() {
            try {
                console.log('æ­£åœ¨å¾ä¼ºæœå™¨è¼‰å…¥é€²åº¦...');
                const response = await fetch(`${API_BASE_URL}/progress`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('å¾ä¼ºæœå™¨è¼‰å…¥çš„é€²åº¦:', result);
                
                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(course => {
                        const selects = document.querySelectorAll('.status-select');
                        selects.forEach(select => {
                            const tableRow = select.closest('tr');
                            const codeCell = tableRow.querySelector('td:first-child');
                            
                            if (codeCell && codeCell.textContent.trim() === course.code) {
                                select.value = course.status || 'æœªé–‹å§‹';
                                updateSelectColor(select);
                                
                                const noteInput = tableRow.querySelector('.note-input');
                                if (noteInput && course.note) {
                                    noteInput.value = course.note;
                                }
                                
                                const dateInput = tableRow.querySelector('.date-input');
                                if (dateInput && course.completedDate) {
                                    dateInput.value = course.completedDate;
                                }
                            }
                        });
                    });
                    
                    updateAllStatistics();
                    showNotification(`æˆåŠŸå¾ä¼ºæœå™¨è¼‰å…¥ ${result.data.length} ç­†é€²åº¦è³‡æ–™ï¼`);
                } else {
                    console.log('ä¼ºæœå™¨ä¸­æ²’æœ‰é€²åº¦è³‡æ–™ï¼Œä½¿ç”¨é è¨­è¨­å®š');
                }
            } catch (error) {
                console.error('å¾ä¼ºæœå™¨è¼‰å…¥é€²åº¦å¤±æ•—:', error);
                throw error; // è®“ä¸Šå±¤è™•ç†éŒ¯èª¤
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            initializeTable();
            await initApp();
        });

        window.addEventListener('beforeunload', function() {
            // åŒæ­¥ä¿å­˜åˆ°ä¼ºæœå™¨ï¼ˆæ³¨æ„ï¼šbeforeunload ä¸­çš„ç•°æ­¥æ“ä½œå¯èƒ½ä¸æœƒå®Œæˆï¼‰
            navigator.sendBeacon(`${API_BASE_URL}/save-progress`, JSON.stringify({
                courses: getCurrentCoursesData()
            }));
        });

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                saveProgressToServer(); // é é¢éš±è—æ™‚ä¿å­˜é€²åº¦
            }
        });

        // é¡¯ç¤ºé€šçŸ¥å‡½æ•¸
        function showNotification(message) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // æ‰‹å‹•ä¿å­˜å‡½æ•¸
        async function manualSave() {
            try {
                await saveProgressToServer();
                showNotification('æ‰‹å‹•ä¿å­˜åˆ°ä¼ºæœå™¨å®Œæˆï¼');
            } catch (error) {
                showNotification('æ‰‹å‹•ä¿å­˜å¤±æ•—ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
            }
        }

        // æ‰‹å‹•è¼‰å…¥å‡½æ•¸
        function manualLoad() {
            loadProgress();
            updateAllStatistics();
            showNotification('æ‰‹å‹•è¼‰å…¥å®Œæˆï¼');
        }

        // é‡è¨­æ‰€æœ‰é€²åº¦å‡½æ•¸
        function resetAllProgress() {
            if (confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰é€²åº¦å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                const selects = document.querySelectorAll('.status-select');
                selects.forEach(select => {
                    select.value = 'æœªé–‹å§‹';
                    updateSelectColor(select);
                });
                
                const noteInputs = document.querySelectorAll('.note-input');
                noteInputs.forEach(input => {
                    input.value = input.getAttribute('data-original') || '';
                });
                
                const dateInputs = document.querySelectorAll('.date-input');
                dateInputs.forEach(input => {
                    input.value = '';
                });
                
                updateAllStatistics();
                saveProgressToServer();
                showNotification('æ‰€æœ‰é€²åº¦å·²é‡è¨­ï¼');
            }
        }

        // åˆ‡æ›çµ±è¨ˆé¡¯ç¤ºå‡½æ•¸
        function toggleStats() {
            const statsPanel = document.getElementById('statsPanel');
            const toggleBtn = document.getElementById('statsToggle');
            
            if (statsPanel.style.display === 'none') {
                statsPanel.style.display = 'grid';
                toggleBtn.textContent = 'ğŸ“Š éš±è—';
            } else {
                statsPanel.style.display = 'none';
                toggleBtn.textContent = 'ğŸ“Š çµ±è¨ˆ';
            }
        }

        // é‡æ–°è¼‰å…¥è¡¨æ ¼å‡½æ•¸
        function reloadTable() {
            if (confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥è¡¨æ ¼å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°‡æœƒä¸Ÿå¤±ï¼')) {
                initializeTable();
                loadProgress();
                updateAllStatistics();
                showNotification('è¡¨æ ¼å·²é‡æ–°è¼‰å…¥ï¼');
            }
        }

        // åŒ¯å…¥è³‡æ–™å‡½æ•¸
        function importData() {
            document.getElementById('dataFile').click();
        }

        // è™•ç†è³‡æ–™åŒ¯å…¥
        function handleDataImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.courses) {
                        // æ¸…ç©ºç•¶å‰è³‡æ–™
                        localStorage.setItem('mathProgressData', JSON.stringify(data));
                        
                        // é‡æ–°è¼‰å…¥é é¢è³‡æ–™
                        loadProgress();
                        updateAllStatistics();
                        showNotification('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                    } else {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼');
                    }
                } catch (error) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„JSONæª”æ¡ˆï¼');
                    console.error('è³‡æ–™åŒ¯å…¥éŒ¯èª¤:', error);
                }
            };
            reader.readAsText(file);
        }

        // åŒ¯å‡ºä¼ºæœå™¨è³‡æ–™
        async function exportServerData() {
            try {
                const response = await fetch(`${API_BASE_URL}/progress`);
                if (response.ok) {
                    const result = await response.json();
                    const dataStr = JSON.stringify(result, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `math_progress_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    showNotification('ä¼ºæœå™¨è³‡æ–™å·²åŒ¯å‡ºï¼');
                } else {
                    throw new Error('ç„¡æ³•å–å¾—ä¼ºæœå™¨è³‡æ–™');
                }
            } catch (error) {
                console.error('åŒ¯å‡ºä¼ºæœå™¨è³‡æ–™å¤±æ•—:', error);
                showNotification('åŒ¯å‡ºä¼ºæœå™¨è³‡æ–™å¤±æ•—');
            }
        }
        
        // é¡¯ç¤ºä¼ºæœå™¨çµ±è¨ˆ
        async function showServerStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    const message = `ä¼ºæœå™¨çµ±è¨ˆè³‡è¨Šï¼š\nç¸½æ•¸: ${stats.total}\nå·²å®Œæˆ: ${stats.completed}\né€²è¡Œä¸­: ${stats.inProgress}\næœªé–‹å§‹: ${stats.notStarted}\nå®Œæˆç‡: ${stats.completionRate}%`;
                    alert(message);
                } else {
                    throw new Error('ç„¡æ³•å–å¾—çµ±è¨ˆè³‡æ–™');
                }
            } catch (error) {
                console.error('å–å¾—ä¼ºæœå™¨çµ±è¨ˆå¤±æ•—:', error);
                alert('ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨');
            }
        }
        
        // å–å¾—ç•¶å‰èª²ç¨‹è³‡æ–™ï¼ˆç”¨æ–¼ beforeunloadï¼‰
        function getCurrentCoursesData() {
            const courses = [];
            const selects = document.querySelectorAll('.status-select');
            
            selects.forEach(select => {
                const row = select.closest('tr');
                if (!row.classList.contains('chapter-row') && !row.classList.contains('chapter-summary-row')) {
                    const cells = row.querySelectorAll('td');
                    const noteInput = row.querySelector('.note-input');
                    const dateInput = row.querySelector('.date-input');

                    courses.push({
                        code: cells[0].textContent.trim(),
                        name: cells[1].textContent.trim(),
                        time: cells[2].textContent.trim(),
                        status: select.value,
                        note: noteInput ? noteInput.value.trim() : '',
                        completedDate: dateInput ? dateInput.value.trim() : ''
                    });
                }
            });
            
            return courses;
        }

        // Save data to backend server
        async function saveData() {
          const data = document.getElementById('dataInput').value;
          console.log('Data to be saved:', data); // Log data to be saved
          if (!data) {
            alert('Please enter some data to save.');
            return;
          }

          try {
            const response = await fetch('http://localhost:3000/save', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ data }),
            });

            if (response.ok) {
              const result = await response.json();
              console.log('Save response:', result); // Log save response
              alert(`Data saved with ID: ${result.id}`);
            } else {
              console.error('Failed to save data');
              alert('Failed to save data.');
            }
          } catch (error) {
            console.error('Error saving data:', error);
            alert('An error occurred while saving data.');
          }
        }

        async function fetchData() {
          try {
            const response = await fetch('http://localhost:3000/data');
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Fetched data:', data); // Log fetched data
            const dataList = document.getElementById('dataList');
            dataList.innerHTML = '';
            data.forEach(item => {
              const listItem = document.createElement('li');
              listItem.textContent = `ID: ${item.id}, Data: ${item.data}`;
              dataList.appendChild(listItem);
            });
          } catch (error) {
            console.error('Error fetching data:', error);
            alert('Failed to fetch data. Please check the backend server.');
          }
        }

        // Fetch data on page load
        window.onload = fetchData;
    </script>
</body>
</html>